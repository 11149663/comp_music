---
title: "My Computational Musicology Portfolio"
author: "Jason Z."
date: "Feb/Mar 2021"
output:
  flexdashboard::flex_dashboard:
    storyboard: TRUE
    theme: flatly
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# stackoverflow.com/questions/33402920/using-ggplot2-and-special-characters
# switch between reading error messages and reading track labels
# Sys.setlocale("LC_ALL", "Japanese") 
# options(encoding = "UTF-8")
```

```{r, include = FALSE}
## Loading libraries
library(tidyverse) 
library(spotifyr)
library(compmus)
library(plotly)
library(flexdashboard)
library(readxl)
library(grid)
library(gridExtra)
```

```{r, include = FALSE}
# Retrieve my portfolio playlists
y2011 <- get_playlist_audio_features("", "544c7nycI0F40aO2dZkWXm")
y2012 <- get_playlist_audio_features("", "4GRDx8ryZypvBaZFSh4kWa")
y2013 <- get_playlist_audio_features("", "1ys2ATlrbdoh9JfT8fKToA")
y2014 <- get_playlist_audio_features("", "1yqM9ChrxHxbOJUiYbFPLZ")
y2015 <- get_playlist_audio_features("", "6WmvRZEr7bWnCscOFVhNJB")
y2016 <- get_playlist_audio_features("", "60OfN9aW1vJHvhqUOEVxMQ")
y2017 <- get_playlist_audio_features("", "4c9iuV5x9M9FHumOjGRfg0")
y2018 <- get_playlist_audio_features("", "3gIybzPIbiJSzoeU7lDyDj")
y2019 <- get_playlist_audio_features("", "0MIzuDtEA31PrJ68ZXdeqx")
y2020 <- get_playlist_audio_features("", "1HN2I323QTNX5jofgP8fiC")
```

```{r, include = FALSE}
# Mutate into category:year
combined_year_pt1 <- 
  bind_rows(
    y2011 %>% mutate(category = "2011", mode = ifelse(mode == 0, "Minor", "Major")),
    y2012 %>% mutate(category = "2012", mode = ifelse(mode == 0, "Minor", "Major")),
    y2013 %>% mutate(category = "2013", mode = ifelse(mode == 0, "Minor", "Major")),
    y2014 %>% mutate(category = "2014", mode = ifelse(mode == 0, "Minor", "Major")),
    y2015 %>% mutate(category = "2015", mode = ifelse(mode == 0, "Minor", "Major")),
    y2016 %>% mutate(category = "2016", mode = ifelse(mode == 0, "Minor", "Major"))
  )

combined_year_pt2 <- 
  bind_rows(
    y2015 %>% mutate(category = "2015", mode = ifelse(mode == 0, "Minor", "Major")),
    y2016 %>% mutate(category = "2016", mode = ifelse(mode == 0, "Minor", "Major")),
    y2017 %>% mutate(category = "2017", mode = ifelse(mode == 0, "Minor", "Major")),
    y2018 %>% mutate(category = "2018", mode = ifelse(mode == 0, "Minor", "Major")),
    y2019 %>% mutate(category = "2019", mode = ifelse(mode == 0, "Minor", "Major")),
    y2020 %>% mutate(category = "2020", mode = ifelse(mode == 0, "Minor", "Major"))
  )
```

```{r, include = FALSE}
y2020 %>%
  summarise(
    mean_valence = mean(valence),
    mean_energy = mean(energy),
    sd_valence = sd(valence),
    sd_energy = sd(energy),
    median_valence = median(valence),
    median_energy = median(energy),
    mad_valence = mad(valence),
    mad_energy = mad(energy)
  )
```

### 6: **|New|** Chordograms

```{r, include = FALSE}

circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```


```{r, include = FALSE}
rosebud_chordkey <-
  get_tidy_audio_analysis("1Rtcq2RErgV3NuQvKdCNf6") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

boys_chordkey <-
  get_tidy_audio_analysis("6hVVhORwKxGgJ9PC2jaA2R") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )
```


```{r, include = FALSE}
rosebud_key <- rosebud_chordkey %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if desired
    method = "aitchison",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")

rosebud_chord <- rosebud_chordkey %>% 
  compmus_match_pitch_template(
    chord_templates,       # Change to chord_templates if desired
    method = "manhattan",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "") +
  theme(axis.text=element_text(size=5))

boys_key <- boys_chordkey %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if desired
    method = "aitchison",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")

boys_chord <- boys_chordkey %>% 
  compmus_match_pitch_template(
    chord_templates,       # Change to chord_templates if desired
    method = "manhattan",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "") +
  theme(axis.text=element_text(size=5))

```

```{r, echo = FALSE}
grid.arrange(arrangeGrob(rosebud_chord, top = grid::textGrob("Rosebud", hjust = 0.15), left = "Chordogram"),
             arrangeGrob(boys_chord, top = grid::textGrob("Processed by the Boys", hjust =0.21)),
             arrangeGrob(rosebud_key, left="Keygrams"), boys_key, ncol=2, nrow=2, widths = c(2.2,2) ,heights = c(2.2,2))
```

***
[W09: Draft]

With the previous songs in mind, I have created key- and chordograms of
top tracks from 2018 (Rosebud by U.S. Girls) and 2020 (Processed by the Boys 
by Protomartyr). 

The level of prominence of each key/chord is represent by a darker colour.

I used "norm = manhattan; distance = manhattan" for both chordograms, and
"norm = manhattan; distance = aitchison" for both keygrams.

**Need to work out my findings**

Things to consider:
Compare above to top track of years 2016 (or other/more years).


### 1: Introduction - Diving into my **10-years** worth of last.fm **music log**
 
<span style="text-decoration:underline">**What is your corpus, why did you choose it, and what do you think is interesting about it?**</span>

Last.fm is an online music database, a music recommender system, and a social 
networking service, which was founded in the days when MSN, Myspace, and
Runescape were still a thing. In general, the website offers a plugin for you 
to install on your PC and phone, which can track your listening behaviour. 
One listen, a *scrobble*, is then transferred (or "scrobbled") to the database 
and displayed on your personal profile. Based on the collected data, it could 
also recommend you new music to discover or connect you to people with similar music taste.
Although the social aspects have been watered down, I've still been using their 
service ever since June 2011 ([my profile](https://last.fm/user/wutsmainaem)). 
With a *vast* amount of data up for grabs, it would be a waste to leave the data 
as it is. That is why I'm interested in learning more about 
**how my listening has changed over the years**. 

As of December 31st of 2020, I have approximately over 97.000 registered scrobbles 
and 24.000 unique tracks over the course of ten years. The size is too big for 
the scope of this course, so I will be limiting to a set number of top tracks 
each year. This makes it easier to explore the data without losing much overview 
of my general listening behaviour.

<span style="text-decoration:underline">**What are the natural groups or comparison points in your corpus and what is expected between them?**</span>

My corpus will be divided in years **from June 2011 to the end of 2020**.

*[Draft: As I grow older, some changes ... teenage/adolescent years are formative,*
*some consistencies to be expected ... new music styles introduced*
*... new music discovered along the way]*

<span style="text-decoration:underline">**How representative are the tracks in your corpus for the groups you want to compare?**</span>

I used [Spotlistr](https://www.spotlistr.com/search/lastfm-top-for-time-period) and [Soundiiz](https://soundiiz.com/)
to transfer **60 tracks per year** from my last.fm profile to Spotify. 
As I've been listening to albums more than separate songs at some point in life,
I decided to grab **top 10 tracks** and the remaining **50 tracks between #11-100** 
at random to broaden the scope. Sometimes the tool didn't pick the correct 
track due to changes in the metadata, for which I adjusted manually. Examples
include band name changes, such as 'Viet Cong' to 'Preoccupations' and 
'Andrew Jackson Jihad' to 'AJJ'. If a top 10 song was missing, then the next song 
was selected (#11 and so on). I also removed tracks that are considered as intros
or interludes.

My corpus comes with a few limitations:

-  I've only started using the last.fm plugin on my smartphone since 
February 2015. Before then, I relied on my PC/laptop to log my scrobbles, which
makes the data between 2011 and 2014 less accurate.

- Possible under-representation of certain music styles in my 60 track selections. 
As a simple example: song 1 of style A has 100 scrobbles, song 2 and 3 of style B 
have 60 each. In total, style A has 100 scrobbles, whereas style B has 120, which 
is more than style A.

- On a handful occasions, I fell asleep with my music and last.fm still on.

<span style="text-decoration:underline">**Identify several tracks in your corpus that are either extremely typical or atypical**</span>

...

***

![Fig 1. Logo of last.fm](lastfm.jpg){width=100%}

View my corpus per year:

- 2011
- 2012
- 2013
- 2014
- 2015
- 2016
- 2017
- 2018
- 2019
- 2020

### 2: How much did I spend on listening to music?

```{r, echo = FALSE}
scrobbles <- read_excel("C:/Users/Jason/Desktop/CompMus/Scrobbles.xlsx")

listens <- scrobbles %>%
  ggplot(aes(x = period, y = scrobbles)) +
  theme_light() +
  ggtitle("Number of 'scrobbles' per quartile") +
  geom_col(width = 0.9) +
  labs(x="year/quartile", y="number of scrobbles") + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

ggplotly(listens)
```

***
[W06: Draft]

Things to do:

- Add dashed vertical lines with relevant events, which could explain changes in listening behaviour. Examples:

2014/2: "CE middelbare school" (correspond to lower valence as seen in next figures?)

Pre-2015: Only 'scrobbles' from PC/laptop.

2015/1: New phone and subscribed to Spotify with last.fm

2016/3: Start UvA

2018/3: Half year in Hong Kong

- Show within each bar the proportion of top-60 songs (probably easier to do per year rather than per quartile).

- Turn above text into a readable story.

### 3.1: Mood features - From sad, sadder, saddest...

```{r, echo = FALSE}
valence_vs_energy_pt1 <- combined_year_pt1 %>%
  ggplot(aes(x = valence,
             y = energy,
             color = mode,
             size = tempo,
             label = track.name)) +
  facet_wrap(~category) +
  geom_point(position = 'jitter', 
             alpha = 0.6) +
  geom_rug(size = 0.20) +
  ggtitle("Track-level comparison") +
  theme_light() +
  scale_color_manual(values = c("Minor" = "#227788", "Major" = "#DD8877"),
                     guide = "legend") +
  scale_x_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_y_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_size_continuous(range = c(0, 5),
                        guide = "none")

ggplotly(valence_vs_energy_pt1)
```
***
[W06: Draft]

### 3.2: Mood features - ... to fast, loud, and noisy (relatively speaking).

```{r, echo = FALSE}
valence_vs_energy_pt2 <- combined_year_pt2 %>%
  ggplot(aes(x = valence,
             y = energy,
             color = mode,
             size = tempo,
             label = track.name)) +
  facet_wrap(~category) +
  geom_point(position = 'jitter', 
             alpha = 0.6) +
  geom_rug(size = 0.20) +
  ggtitle("Track-level comparison") +
  theme_light() +
  scale_color_manual(values = c("Minor" = "#227788", "Major" = "#DD8877"),
                     guide = "legend") +
  scale_x_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_y_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_size_continuous(range = c(0, 5),
                        guide = "none")

ggplotly(valence_vs_energy_pt2)
```
```{r, include = FALSE}
#combined_year_pt1 %>%
#  mutate(artists = select(!!!track.artists, name))
  
# scrobbles$scrobbles
```


***
[W06: Draft]

### 4: Investigating the scope of my outliers in **chromagrams**

```{r, echo = FALSE}

juhachi_chroma <-
  get_tidy_audio_analysis("2FghAESlnAFukLy5j2Ascp") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

juhachi_chroma %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>% # manhattan
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  ggtitle("Jùhachi by Sylvain Chauveau") +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

chihei_chroma <-
  get_tidy_audio_analysis("4NV9wYTFbFuOndIUUyE5Pi") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

chihei_chroma %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>% # euclidean
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  ggtitle("Far from the Atmosphere by Chihei Hatakeyama") +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

lbolt_chroma <-
  get_tidy_audio_analysis("7DNRAyfqNpN0qzrS5JmJwY") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

lbolt_chroma %>%
  mutate(pitches = map(pitches, compmus_normalise, "chebyshev")) %>% # chebyshev
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  ggtitle("Dead Cowboy by Lightning Bolt") +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

```

***
[W07: Draft]

Outlier: Song's very reliant on silence with occasional ...

Things to consider: 
Most listened song vs favourite song of 2020.
Compare multiple low valence/energy songs and see if they have something in common.

### Optional: DTW of Dreams cover by Faye Wong

```{r, echo = FALSE}
faye <-
  get_tidy_audio_analysis("1SGPQAdXXDbcRX8kGoBiN3") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

dolores <-
  get_tidy_audio_analysis("4JGKZS7h4Qa16gOU3oNETV") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
```

```{r, echo = FALSE}

compmus_long_distance(
  dolores %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  faye %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  feature = pitches,
  method = "angular"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Dreams by Cranberries", y = "Dreamer by Faye Wong") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

```

***
[W07: Draft]

Reasoning on inclusion: In top 2014. Might become an outtake if it doesn't
fit in my portfolio story.

### 5: Self-similarity Matrices

```{r, echo = FALSE}
boys <-
  get_tidy_audio_analysis("6hVVhORwKxGgJ9PC2jaA2R") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(pitches = map(segments, compmus_summarise, pitches,
                       method = "rms", norm = "euclidean")) %>%
  mutate(timbre = map(segments, compmus_summarise, timbre,
                     method = "rms", norm = "euclidean"))
bind_rows(
  boys %>% 
    compmus_self_similarity(pitches, "euclidean") %>% 
    mutate(d = d / max(d), type = "Chroma"),
  boys %>% 
    compmus_self_similarity(timbre, "euclidean") %>% 
    mutate(d = d / max(d), type = "Timbre")
  ) %>%
  mutate() %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  ggtitle("Processed by the Boys by Protomartyr") +
  facet_wrap(~type) +
  theme_classic() +
  scale_fill_viridis_c() +
  labs(x = "", y = "")
```


***
[W08: Draft]

On the left, you see two self-similarity matrices displaying chroma and timbre 
features of Processed by the Boys by Protomartyr (top track of 2020). 
As for the settings:segments are set in bars, applied normalization and summary 
statistics are euclidean and root mean square, respectively. The darker the 
colour brightness, the more similar the segments are compared to segments before 
it in time.

Findings:

- ...

- ...

Things to consider:
Compare above to top track of years 2016, 2018 (Rosebud) or other/more years.

### Conclusions

TODO

***
TODO
