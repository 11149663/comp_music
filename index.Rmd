---
title: "My Computational Musicology Portfolio"
author: "Jason Z."
date: "Feb/Mar 2021"
output:
  flexdashboard::flex_dashboard:
    storyboard: TRUE
    theme: flatly
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# stackoverflow.com/questions/33402920/using-ggplot2-and-special-characters
# switch between reading error messages and reading track labels
Sys.setlocale("LC_ALL", "Japanese") 
options(encoding = "UTF-8")
```

```{r, include = FALSE}
## Loading libraries
library(tidyverse) 
library(spotifyr)
library(compmus)
library(plotly)
library(flexdashboard)
library(readxl)
```

```{r, include = FALSE}
# Retrieve my portfolio playlists
y2011 <- get_playlist_audio_features("", "544c7nycI0F40aO2dZkWXm")
y2012 <- get_playlist_audio_features("", "4GRDx8ryZypvBaZFSh4kWa")
y2013 <- get_playlist_audio_features("", "1ys2ATlrbdoh9JfT8fKToA")
y2014 <- get_playlist_audio_features("", "1yqM9ChrxHxbOJUiYbFPLZ")
y2015 <- get_playlist_audio_features("", "6WmvRZEr7bWnCscOFVhNJB")
y2016 <- get_playlist_audio_features("", "60OfN9aW1vJHvhqUOEVxMQ")
y2017 <- get_playlist_audio_features("", "4c9iuV5x9M9FHumOjGRfg0")
y2018 <- get_playlist_audio_features("", "3gIybzPIbiJSzoeU7lDyDj")
y2019 <- get_playlist_audio_features("", "0MIzuDtEA31PrJ68ZXdeqx")
y2020 <- get_playlist_audio_features("", "1HN2I323QTNX5jofgP8fiC")
```

```{r, include = FALSE}
# Mutate into category:year
combined_year_pt1 <- 
  bind_rows(
    y2011 %>% mutate(category = "2011", mode = ifelse(mode == 0, "Minor", "Major")),
    y2012 %>% mutate(category = "2012", mode = ifelse(mode == 0, "Minor", "Major")),
    y2013 %>% mutate(category = "2013", mode = ifelse(mode == 0, "Minor", "Major")),
    y2014 %>% mutate(category = "2014", mode = ifelse(mode == 0, "Minor", "Major")),
    y2015 %>% mutate(category = "2015", mode = ifelse(mode == 0, "Minor", "Major")),
    y2016 %>% mutate(category = "2016", mode = ifelse(mode == 0, "Minor", "Major"))
  )

combined_year_pt2 <- 
  bind_rows(
    y2015 %>% mutate(category = "2015", mode = ifelse(mode == 0, "Minor", "Major")),
    y2016 %>% mutate(category = "2016", mode = ifelse(mode == 0, "Minor", "Major")),
    y2017 %>% mutate(category = "2017", mode = ifelse(mode == 0, "Minor", "Major")),
    y2018 %>% mutate(category = "2018", mode = ifelse(mode == 0, "Minor", "Major")),
    y2019 %>% mutate(category = "2019", mode = ifelse(mode == 0, "Minor", "Major")),
    y2020 %>% mutate(category = "2020", mode = ifelse(mode == 0, "Minor", "Major"))
  )
```

### **1. Lorem Ipsum**: Yuddy Lam.
 
**Hallotjes?**

inspirerende tekst

***
Sources:

- https://last.fm/user/wutsmainaem
- https://www.spotlistr.com/search/lastfm-top-for-time-period
- https://soundiiz.com/

### 2. Bar graph

```{r, echo = FALSE}
scrobbles <- read_excel("C:/Users/Jason/Desktop/CompMus/Scrobbles.xlsx")

listens <- scrobbles %>%
  ggplot(aes(x = period, y = scrobbles)) +
  theme_light() +
  ggtitle("Number of 'scrobbles' per quartile") +
  geom_col(width = 0.9) +
  labs(x="year/quartile", y="number of scrobbles") + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

ggplotly(listens)
```

***
TODO:

- Add dashed vertical lines with relevant life events, which could explain changes in listening behaviour. Examples:

2014/2: "CE middelbare school" (correspond to lower valence as seen in next figures?)

Pre-2015: Only 'scrobbles' from PC/laptop.

2015/1: New phone and subscribed to Spotify with last.fm

2016/3: Start UvA

2018/3: Half year in Hong Kong

- Show within each bar the proportion of top-60 songs (probably easier to do per year rather than per quartile).

- Turn above text into a readable story.

### 3.1 Track-level comparison: Part 1

```{r, echo = FALSE}
valence_vs_energy_pt1 <- combined_year_pt1 %>%
  ggplot(aes(x = valence,
             y = energy,
             color = mode,
             size = tempo,
             label = track.name)) +
  facet_wrap(~category) +
  geom_point(position = 'jitter', 
             alpha = 0.6) +
  geom_rug(size = 0.20) +
  ggtitle("Track-level comparison") +
  theme_light() +
  scale_color_manual(values = c("Minor" = "#227788", "Major" = "#DD8877"),
                     guide = "legend") +
  scale_x_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_y_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_size_continuous(range = c(0, 5),
                        guide = "none")

ggplotly(valence_vs_energy_pt1)
```
***
Text

### 3.2 Track-level comparison: Part 2

```{r, echo = FALSE}
valence_vs_energy_pt2 <- combined_year_pt2 %>%
  ggplot(aes(x = valence,
             y = energy,
             color = mode,
             size = tempo,
             label = track.name)) +
  facet_wrap(~category) +
  geom_point(position = 'jitter', 
             alpha = 0.6) +
  geom_rug(size = 0.20) +
  ggtitle("Track-level comparison") +
  theme_light() +
  scale_color_manual(values = c("Minor" = "#227788", "Major" = "#DD8877"),
                     guide = "legend") +
  scale_x_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_y_continuous(breaks = c(0, 0.50, 1),
                     minor_breaks = NULL) +
  scale_size_continuous(range = c(0, 5),
                        guide = "none")

ggplotly(valence_vs_energy_pt2)
```
```{r, include = FALSE}
#combined_year_pt1 %>%
#  mutate(artists = select(!!!track.artists, name))
  
# scrobbles$scrobbles
```


***
Text

### 4 Chromagram

```{r, echo = FALSE}

juhachi_chroma <-
  get_tidy_audio_analysis("2FghAESlnAFukLy5j2Ascp") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

juhachi_chroma %>%
  mutate(pitches = map(pitches, compmus_normalise, "manhattan")) %>% # manhattan
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  ggtitle("JÃ¹hachi by Sylvain Chauveau") +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

chihei_chroma <-
  get_tidy_audio_analysis("4NV9wYTFbFuOndIUUyE5Pi") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

chihei_chroma %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>% # euclidean
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  ggtitle("Far from the Atmosphere by Chihei Hatakeyama") +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

lbolt_chroma <-
  get_tidy_audio_analysis("7DNRAyfqNpN0qzrS5JmJwY") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

lbolt_chroma %>%
  mutate(pitches = map(pitches, compmus_normalise, "chebyshev")) %>% # chebyshev
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  ggtitle("Dead Cowboy by Lightning Bolt") +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

```

***
Song's very reliant on silence with occasional ...

Also interesting: 
Most listened song vs favourite song of 2020.
Compare multiple low valence/energy songs and see if they have something in common.

### Optional: DTW of Dreams cover by Faye Wong

```{r, echo = FALSE}
faye <-
  get_tidy_audio_analysis("1SGPQAdXXDbcRX8kGoBiN3") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

dolores <-
  get_tidy_audio_analysis("4JGKZS7h4Qa16gOU3oNETV") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)
```

```{r, echo = FALSE}

compmus_long_distance(
  dolores %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  faye %>% mutate(pitches = map(pitches, compmus_normalise, "euclidean")),
  feature = pitches,
  method = "angular"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Dreams by Cranberries", y = "Dreamer by Faye Wong") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

```

***
Reasoning on inclusion: In top 2014.

### 5 Self-similarity Matrices

***

### Conclusions

TODO

***
TODO
